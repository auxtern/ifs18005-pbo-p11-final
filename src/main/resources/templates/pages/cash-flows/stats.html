<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/base}"
  lang="id"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delcom App - Statistik</title>
  </head>
  <body>
    <div layout:fragment="content" class="mt-3">
      <div class="card">
        <div class="card-header d-flex bg-light sticky-top">
          <div class="flex-fill">
            <a th:href="@{/}" class="text-decoration-none">
              <small class="text-muted"> &lt; Kembali </small>
            </a>
            <h5>Statistik Cash Flow</h5>
          </div>
          <div>
            <div>
              <a th:href="@{/auth/logout}" class="btn btn-sm btn-danger w-100"
                >Keluar</a
              >
            </div>
            <div></div>
          </div>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <!-- Content Tabel -->
            <div class="flex-fill">
              <table class="table table-bordered">
                <tr>
                  <th class="table-light">Total Income</th>
                  <td
                    th:text="${#numbers.formatCurrency(cashFlowStat.totalIncome)}"
                  >
                    0
                  </td>
                </tr>
                <tr>
                  <th class="table-light">Total Outcome</th>
                  <td
                    th:text="${#numbers.formatCurrency(cashFlowStat.totalOutcome)}"
                  >
                    0
                  </td>
                </tr>
                <tr>
                  <th class="table-light">Balance</th>
                  <td
                    th:class="${(cashFlowStat.balance) >= 0} ? 'text-success fw-bold' : 'text-danger fw-bold'"
                    th:text="${#numbers.formatCurrency(cashFlowStat.balance)}"
                  >
                    0
                  </td>
                </tr>
              </table>

              <!-- Tabel Income per Bulan -->
              <div class="mt-4">
                <h6>Income per Bulan</h6>
                <table class="table table-sm table-striped">
                  <thead>
                    <tr>
                      <th>Bulan</th>
                      <th class="text-end">Jumlah</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="label, status : ${cashFlowStat.statLabels}">
                      <td th:text="${label}">-</td>
                      <td
                        class="text-end text-success"
                        th:text="${#numbers.formatCurrency(cashFlowStat.statIncomes.get(status.index))}"
                      >
                        0
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Tabel Outcome per Bulan -->
              <div class="mt-4">
                <h6>Outcome per Bulan</h6>
                <table class="table table-sm table-striped">
                  <thead>
                    <tr>
                      <th>Bulan</th>
                      <th class="text-end">Jumlah</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="label, status : ${cashFlowStat.statLabels}">
                      <td th:text="${label}">-</td>
                      <td
                        class="text-end text-danger"
                        th:text="${#numbers.formatCurrency(cashFlowStat.statOutcomes.get(status.index))}"
                      >
                        0
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Content Chart -->
            <div class="ms-4">
              <!-- Pie Chart -->
              <div class="chart-container" style="width: 400px; height: 300px">
                <canvas id="cashFlowPieChart"></canvas>
              </div>

              <!-- Line Chart untuk Trend Bulanan -->
              <div
                class="chart-container mt-4"
                style="width: 500px; height: 300px"
              >
                <canvas id="monthlyTrendChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <div layout:fragment="others-js">
      <!-- Import Library -->
      <script src="/assets/vendor/chart.js-4.5.1/package/dist/chart.umd.min.js"></script>
      <script src="/assets/vendor/chartjs-plugin-datalabels-2.2.0/package/dist/chartjs-plugin-datalabels.min.js"></script>

      <!-- Setup Chart -->
      <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
          // Data dari Thymeleaf menggunakan method dari DTO
          const totalIncome = [[${cashFlowStat.totalIncome}]] || 0;
          const totalOutcome = [[${cashFlowStat.totalOutcome}]] || 0;
          const balance = [[${cashFlowStat.balance}]] || 0;

          // Gunakan method JSON dari DTO
          const statLabels = [(${cashFlowStat.statLabelsJson})];
          const statIncomes = [(${cashFlowStat.statIncomesJson})];
          const statOutcomes = [(${cashFlowStat.statOutcomesJson})];

          // Pie Chart - Perbandingan Income vs Outcome
          {
            const pieChart = document.getElementById('cashFlowPieChart');

            const dataPie = {
              labels: ['Income', 'Outcome'],
              datasets: [{
                data: [totalIncome, totalOutcome],
                backgroundColor: [
                  'rgba(75, 192, 192, 0.8)',
                  'rgba(255, 99, 132, 0.8)'
                ],
                borderColor: [
                  'rgba(75, 192, 192, 1)',
                  'rgba(255, 99, 132, 1)'
                ],
                borderWidth: 1
              }]
            };

            const configPie = {
              type: 'pie',
              data: dataPie,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'top',
                  },
                  title: {
                    display: true,
                    text: 'Perbandingan Income vs Outcome'
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = Math.round((value / total) * 100);
                        return `${label}: Rp${value.toLocaleString('id-ID')} (${percentage}%)`;
                      }
                    }
                  },
                  datalabels: {
                    formatter: (value, ctx) => {
                      const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                      const percentage = Math.round((value / total) * 100);
                      return `${percentage}%`;
                    },
                    color: '#fff',
                    font: {
                      weight: 'bold',
                      size: 12
                    }
                  },
                }
              },
              plugins: [ChartDataLabels]
            };

            new Chart(pieChart, configPie);
          }

          // Line Chart - Trend Bulanan
          {
            const trendChart = document.getElementById('monthlyTrendChart');

            const dataTrend = {
              labels: statLabels,
              datasets: [
                {
                  label: 'Income',
                  data: statIncomes,
                  borderColor: 'rgba(75, 192, 192, 1)',
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  tension: 0.4,
                  fill: true
                },
                {
                  label: 'Outcome',
                  data: statOutcomes,
                  borderColor: 'rgba(255, 99, 132, 1)',
                  backgroundColor: 'rgba(255, 99, 132, 0.2)',
                  tension: 0.4,
                  fill: true
                }
              ]
            };

            const configTrend = {
              type: 'line',
              data: dataTrend,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: {
                    display: true,
                    text: 'Trend Income dan Outcome per Bulan'
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        return `${context.dataset.label}: Rp${context.raw.toLocaleString('id-ID')}`;
                      }
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function(value) {
                        return 'Rp' + value.toLocaleString('id-ID');
                      }
                    }
                  }
                }
              }
            };

            new Chart(trendChart, configTrend);
          }
        });
      </script>
    </div>
  </body>
</html>
